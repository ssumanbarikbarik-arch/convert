/**
 * Core Philosophy: This ruleset enforces a hybrid security model. User-specific data (profiles and conversion history) is
 * protected by a strict ownership model, ensuring users can only access their own information. Global data (like conversion
 * tools and admin roles) is managed by a role-based access control (RBAC) system, where administrators have elevated privileges.
 *
 * Data Structure:
 * - /users/{userId}: Private user profile documents, accessible only by the owning user.
 * - /users/{userId}/conversions/{conversionId}: A subcollection containing a user's private conversion history.
 * - /tools/{toolId}: A global collection of available conversion tools, publicly readable but only manageable by admins.
 * - /roles_admin/{userId}: A global collection used for admin role lookups. The existence of a document for a user's UID in this collection grants them admin privileges.
 *
 * Key Security Decisions:
 * - Admin Role Management: Administrator status is determined by checking for the existence of a document in the `/roles_admin/{userId}`
 *   collection. This is a highly performant and secure pattern (`exists()`) that avoids reading sensitive user documents for authorization checks.
 * - No User Listing: To protect user privacy, listing the entire `/users` collection is explicitly disallowed.
 * - Public vs. Private Data: A clear structural segregation is maintained. Private data is nested under user-specific paths
 *   (`/users/{userId}`), while public-read data (`/tools`) resides in a top-level collection.
 *
 * Denormalization for Authorization:
 * - Conversion documents under `/users/{userId}/conversions` contain a `userId` field. This allows rules to validate ownership
 *   during creation and updates, ensuring data integrity without needing to reference the parent user document.
 * - The `/roles_admin` collection is a form of denormalization. Instead of an `isAdmin` flag on a user document (which would require a `get()` call),
 *   we use a separate, dedicated collection for fast, cost-effective role checks from anywhere in the ruleset.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is the owner of a document,
     * based on a provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the currently authenticated user has administrator privileges
     * by verifying the existence of their UID in the /roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // --------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------

    /**
     * @description Manages user profile documents. A user can create their own profile,
     *              and once created, only they can read, update, or delete it. Listing
     *              all users is explicitly forbidden to protect user privacy.
     * @path        /users/{userId}
     * @allow       auth.uid 'user123' (create): their own document at /users/user123
     * @deny        auth.uid 'user456' (get): the document at /users/user123
     * @principle   Restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Secures a user's conversion history. Only the owner of the data
     *              can read, create, update, or delete their conversion records.
     * @path        /users/{userId}/conversions/{conversionId}
     * @allow       auth.uid 'user123' (list): conversions under /users/user123
     * @deny        auth.uid 'user456' (delete): a conversion under /users/user123
     * @principle   Enforces document ownership within a user-specific subcollection.
     */
    match /users/{userId}/conversions/{conversionId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource != null && request.resource.data.userId == resource.data.userId;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Manages the global collection of conversion tools. This data is
     *              publicly readable by anyone, including unauthenticated users,
     *              but can only be created, modified, or deleted by an administrator.
     * @path        /tools/{toolId}
     * @allow       Any user, signed in or not (get, list): any document in /tools
     * @deny        A non-admin user (create): a new tool document in /tools
     * @principle   Implements public read access with role-based write restrictions.
     */
    match /tools/{toolId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages the collection of administrator roles. Only existing admins
     *              can read this collection or add/remove other administrators. This
     *              prevents non-admins from discovering who the admins are or elevating
     *              their own privileges.
     * @path        /roles_admin/{userId}
     * @allow       An admin user (create): a new admin role at /roles_admin/newUser123
     * @deny        A non-admin user (list): the documents in /roles_admin
     * @principle   Secures role management by restricting all access to current role-holders.
     */
    match /roles_admin/{userId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }
  }
}